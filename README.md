# MicroserviÃ§o de CrÃ©ditos ConstituÃ­dos

Este repositÃ³rio contÃ©m a implementaÃ§Ã£o de um **microserviÃ§o RESTful + Background Service** para consulta e integraÃ§Ã£o de **crÃ©ditos constituÃ­dos**, utilizando **.NET 8**, **PostgreSQL**, **Entity Framework Core**, **CQRS**, **Kafka** e **Docker**.

---

## ğŸ“Œ VisÃ£o Geral

O serviÃ§o Ã© responsÃ¡vel por:

* Receber crÃ©ditos constituÃ­dos via API
* Publicar mensagens em um tÃ³pico Kafka
* Consumir mensagens em background a cada **500 ms**
* Persistir os crÃ©ditos de forma **distinta (nÃ£o bulk)**
* Disponibilizar consultas REST
* Expor endpoints de **saÃºde do serviÃ§o**

---

## ğŸ§± Arquitetura

A soluÃ§Ã£o segue os princÃ­pios de **Clean Architecture** e **CQRS**:

```
src/
 â”œâ”€â”€ Credit.Api              â†’ API REST + Health Checks
 â”œâ”€â”€ Credit.Application      â†’ Commands, Queries, Validators, Interfaces
 â”œâ”€â”€ Credit.Domain           â†’ Entidades de domÃ­nio
 â”œâ”€â”€ Credit.Infrastructure   â†’ EF Core, Kafka, RepositÃ³rios, Background Service
 â””â”€â”€ Credit.Tests            â†’ Testes UnitÃ¡rios
```

### PadrÃµes e PrincÃ­pios Utilizados

* MVC
* CQRS (Command / Query Responsibility Segregation)
* Repository Pattern
* Dependency Injection
* SOLID / DRY / KISS

---

## ğŸš€ Tecnologias Utilizadas

* **.NET 6 (C#)**
* **ASP.NET Core Web API**
* **Entity Framework Core**
* **PostgreSQL**
* **Kafka (Confluent.Kafka)**
* **MediatR**
* **FluentValidation**
* **Docker / Docker Compose**
* **xUnit + Moq**

---

## ğŸ“¡ Endpoints da API

### â• POST `/api/creditos/integrar-credito-constituido`

Integra uma lista de crÃ©ditos e publica mensagens no Kafka.

**Response**

```
202 Accepted
{
  "success": true
}
```

---

### ğŸ” GET `/api/creditos/{numeroNfse}`

Retorna os crÃ©ditos associados a uma NFS-e.

---

### ğŸ” GET `/api/creditos/credito/{numeroCredito}`

Retorna os detalhes de um crÃ©dito especÃ­fico.

---

### â¤ï¸ Health Checks

| Endpoint | DescriÃ§Ã£o      |
| -------- | -------------- |
| `/self`  | ServiÃ§o ativo  |
| `/ready` | ServiÃ§o pronto |

---

## ğŸ—„ï¸ Modelagem de Dados

```sql
CREATE TABLE credito (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    numero_credito VARCHAR(50) NOT NULL,
    numero_nfse VARCHAR(50) NOT NULL,
    data_constituicao DATE NOT NULL,
    valor_issqn DECIMAL(15,2) NOT NULL,
    tipo_credito VARCHAR(50) NOT NULL,
    simples_nacional BOOLEAN NOT NULL,
    aliquota DECIMAL(5,2) NOT NULL,
    valor_faturado DECIMAL(15,2) NOT NULL,
    valor_deducao DECIMAL(15,2) NOT NULL,
    base_calculo DECIMAL(15,2) NOT NULL
);
```

---

## ğŸ”„ Fluxo de Mensageria (Kafka)

1. API recebe crÃ©ditos
2. Publica mensagens no tÃ³pico `integrar-credito-constituido-entry`
3. Background Service consome mensagens a cada **500 ms**
4. Persiste no banco apenas se nÃ£o existir

---

## âš™ï¸ ConfiguraÃ§Ã£o

### `appsettings.json`

```json
{
  "ConnectionStrings": {
    "Postgres": "Host=postgres;Port=5432;Database=creditdb;Username=credit;Password=credit"
  },
  "Kafka": {
    "BootstrapServers": "kafka:9092",
    "Topic": "integrar-credito-constituido-entry"
  }
}
```

---

## ğŸ³ Docker

### Subir toda a infraestrutura

```bash
docker-compose up -d
```

ServiÃ§os disponÃ­veis:

| ServiÃ§o    | Porta |
| ---------- | ----- |
| API        | 8080  |
| PostgreSQL | 5432  |
| Kafka      | 9092  |

Swagger:

```
http://localhost:8080/swagger
```

---

## ğŸ§ª Testes Automatizados

* Framework: **xUnit**
* Mock: **Moq**

Executar testes:

```bash
dotnet test
```

Cobertura:

* Commands
* Validators
* RepositÃ³rios

---

## ğŸ“¦ Principais Pacotes NuGet

* MediatR
* FluentValidation
* Microsoft.EntityFrameworkCore
* Npgsql.EntityFrameworkCore.PostgreSQL
* Confluent.Kafka

---

## ğŸ“„ DecisÃµes Arquiteturais

* **CQRS** para separar leitura e escrita
* **Background Service** para desacoplamento da persistÃªncia
* **Kafka** para mensageria assÃ­ncrona
* **EF Core** com PostgreSQL por robustez
* **Health Checks simples** conforme requisito

---

## âœ… CritÃ©rios do Desafio Atendidos

âœ” API REST funcional
âœ” Background Service
âœ” Mensageria
âœ” PersistÃªncia
âœ” Docker
âœ” Testes unitÃ¡rios
âœ” CÃ³digo limpo e organizado
âœ” DocumentaÃ§Ã£o clara

---

## ğŸ‘¨â€ğŸ’» Autor

Projeto desenvolvido como **desafio tÃ©cnico** para avaliaÃ§Ã£o de arquitetura, boas prÃ¡ticas e domÃ­nio do ecossistema .NET.

---

## ğŸ“Œ ObservaÃ§Ãµes Finais

Este repositÃ³rio estÃ¡ **pronto para avaliaÃ§Ã£o**, podendo ser executado localmente ou em ambiente containerizado sem dependÃªncias externas adicionais.
